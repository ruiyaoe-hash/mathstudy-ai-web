# 混合架构实现方案：Supabase + Express 后端

## 项目现状分析

当前项目使用 Express 后端服务器调用智谱 AI API，需要添加纯 Supabase 方案作为备选，同时保留现有架构。

## 实现方案

### 1. Supabase Edge Functions 实现

**创建 Edge Functions**
- `functions/ai/zhipu-ai.ts` - 智谱 AI API 调用函数
- `functions/ai/generate-questions.ts` - 题目生成函数
- `functions/ai/solve-question.ts` - 解题辅导函数
- `functions/ai/chat.ts` - AI 对话函数

**安全配置**
- 在 Supabase Dashboard 中配置环境变量 `ZHIPU_API_KEY`
- 使用 Edge Functions 的内置环境变量访问机制
- 实现密钥的安全存储和使用

### 2. 前端架构调整

**API 调用抽象层**
- 创建 `src/services/aiService.ts` 统一管理 AI 调用
- 实现环境检测和自动切换机制
- 提供一致的 API 接口给前端组件

**配置管理**
- 在环境变量中添加 `VITE_AI_PROVIDER` 配置项
- 支持 `"supabase"` 和 `"express"` 两种模式
- 实现运行时切换能力

### 3. 保留 Express 后端

**功能增强**
- 添加健康检查端点，检测 AI 服务状态
- 实现故障转移机制，当 Supabase 不可用时自动切换到 Express
- 添加详细的日志记录

**配置管理**
- 保留现有的环境变量配置
- 确保与 Supabase 方案的 API 接口一致性

### 4. 实现步骤

**第一步：配置 Supabase 环境**
1. 在 Supabase Dashboard 中创建项目
2. 配置环境变量 `ZHIPU_API_KEY`
3. 启用 Edge Functions 功能

**第二步：创建 Edge Functions**
1. 初始化 Edge Functions 环境
2. 创建智谱 AI 调用函数
3. 实现与 Express 后端一致的 API 接口
4. 测试 Edge Functions 可用性

**第三步：修改前端代码**
1. 创建统一的 AI 服务抽象层
2. 实现环境检测和自动切换逻辑
3. 修改现有组件使用新的服务层
4. 测试前端调用

**第四步：增强 Express 后端**
1. 添加健康检查和监控
2. 实现故障转移逻辑
3. 确保与 Supabase 方案的兼容性

**第五步：测试和验证**
1. 测试 Supabase 方案的 AI 调用
2. 测试 Express 后端的 AI 调用
3. 测试故障转移机制
4. 验证安全性和性能

## 技术要点

**安全性**
- API 密钥仅存储在服务端环境变量中
- 前端通过安全的 API 调用访问 AI 功能
- Edge Functions 提供隔离的执行环境

**可靠性**
- 双备份架构，确保服务可用性
- 自动故障转移机制
- 详细的错误处理和日志记录

**性能**
- Edge Functions 的全球分布式部署
- Express 后端的本地执行
- 智能路由选择最优路径

**可维护性**
- 统一的 API 接口设计
- 模块化的代码结构
- 清晰的配置管理

## 预期结果

- ✅ 纯 Supabase 方案可独立运行 AI 功能
- ✅ Express 后端作为备选方案保留
- ✅ 前端自动选择最优的 AI 服务提供商
- ✅ 安全的 API 密钥管理
- ✅ 高可用性和可靠性
- ✅ 一致的用户体验